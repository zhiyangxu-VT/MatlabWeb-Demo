<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <title>MatlabWeb-Demo</title>
</head>

<body>
    <div style="max-width:40em">
        <div class="w3-padding w3-left-align w3-xlarge w3-margin-right w3-margin-left w3-margin-bottom w3-card" id="title">
            <a>MatlabWeb-Demo: Basic Image Processing</a>
        </div>

        <div id="action_display" class="w3-card w3-margin w3-padding-small">
            <input type="file" id="img_upload" onchange="analyseImage('')">
            <input type="file" id="img_uploadbasic_info" onchange="analyseImage('basic_info')">
        </div>

        <div class="w3-card w3-margin" id="results">
            <div id="image_display">
            </div>

            <div id="result_display">
            </div>
        </div>
    </div>

    <script>
        function analyseImage(action) {
            var matlab_server = "127.0.0.1";
            var matlab_port = 3000;

            var x = document.getElementById("img_upload"+action);
            var file = x.files[0];

            clear_display();
            display_img(file);

            var formData = new FormData();
            formData.append('uploadfile', file, file.name);

            var xhr = new XMLHttpRequest();
            var url = "http://" + matlab_server + ":" + matlab_port + "/" + action;
            xhr.open("POST", url, true);
            //xhr.setRequestHeader("Access-Control-Allow-Origin", "*");
            xhr.onload = function() {
                if (xhr.status === 200) {
                    display_responce(JSON.parse(xhr.responseText));
                } else {
                    alert('An error occurred, upload failed!');
                }
            }

            xhr.send(formData);
        }

        function clear_display() {
            var result_display = document.getElementById("result_display");
            var img_display = document.getElementById('image_display');
            result_display.innerHTML = "";
            img_display.innerHTML = "";
        }

        function display_img(img) {
            var img_display = document.getElementById('image_display');

            var reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    img_display.innerHTML = ['<img style="width:100%" src="', e.target.result, '"/>'].join('');
                };
            })(img);
            reader.readAsDataURL(img);
        }

        function display_responce(response) {
            var x = document.getElementById("result_display");

            var t = document.createElement("TABLE");
            t.className = "w3-table  w3-striped";
            for (var attr in response) {
                var r = t.insertRow();
                var c1 = r.insertCell(0);
                var c2 = r.insertCell(1);

                c1.innerHTML = attr;
                c2.innerHTML = response[attr];
            }

            x.appendChild(t);
        }
    </script>
</body>

</html>
